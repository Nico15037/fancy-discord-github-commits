name: Discord Webhook Workflow

on:
  push:
    branches: [ main ]

jobs:
  send-commit-webhook:
    runs-on: ubuntu-latest

    steps:
      - name: Split commit message
        id: split_commit
        run: |
          MESSAGE="${GITHUB_EVENT_HEAD_COMMIT_MESSAGE}"
          # First line = title
          TITLE=$(echo "$MESSAGE" | head -n1)
          # Rest of the message = description
          DESCRIPTION=$(echo "$MESSAGE" | tail -n +2)
          if [ -z "$DESCRIPTION" ]; then DESCRIPTION=" "; fi
          # Escape newlines for JSON
          DESCRIPTION_ESCAPED="${DESCRIPTION//$'\n'/\\n}"
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION_ESCAPED" >> $GITHUB_OUTPUT
        env:
          GITHUB_EVENT_HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}

      - name: Discord notification with dynamic embed
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_USERNAME: "THEY'RE ABOUT TO KNOW"
          DISCORD_AVATAR: "https://www.farawaymoon.com/wp-content/uploads/fancy-discord-github-commits-guide-cover.png"
          DISCORD_EMBEDS: ${{ toJson([{
            "title": steps.split_commit.outputs.title,
            "description": steps.split_commit.outputs.description,
            "color": 5814783
          }]) }}
        with:
          args: ""
